@page "/GwentBoard"
@inject PlayerService playerService
@inject NavigationManager navigationManager
@inject IGameService gameService
@inject IStatusService statusService

<div class="background-board">
    <div id="gwent-board" class="gwent-board">
        <div class="board-frame">
            <div class="container-fluid">
                <div class="row g-3">
                    <!-- lewa strona -->
                    <div class="col-12 col-md-3 col-lg-3">
                        <div class="side">
                            <!-- Panel przeciwnika -->
                            <div class="player-info @(statusService.Turn == playerService.EnemyIdentity() ? "border-warning" : "")">
                                <div class="player-top">
                                    <div class="commander-slot">
                                        <img src="" alt="">
                                    </div>
                                    <div id="enemy-faction-label" class="faction-label">@statusService.EnemyLeaderCard.Faction</div>
                                </div>
                                <div class="stats-row mt-3">
                                    <div class="stat">Karty: @statusService.EnemyCardsCount</div>
                                    <div>
                                        @for (int i = 0; i < statusService.EnemyHp; i++)
                                        {
                                            <span class="hp-dot"></span>
                                        }
                                    </div>
                                    <div class="stat">Pkt: @statusService.CardsOnBoard.Sum(x => x.Owner == playerService.EnemyIdentity() ? x.CurrentStrength : 0)</div>
                                </div>
                            </div>

                            <!-- pogoda -->
                            <div class="slot">
                                <div @onclick="async()=>await gameService.WeatherClicked()" id="weather-lane" class="weather-lane">
                                    @foreach (var card in statusService.CardsOnBoard.Where(x => x.Placement == TroopPlacement.Weather))
                                    {
                                        <div class="card-slot"></div>
                                    }
                                </div>
                            </div>

                            <button @onclick="async()=>await gameService.PassClicked()" class="pass-slot">
                                Spasuj
                            </button>

                            <!-- panel gracza -->
                            <div class="player-info @(statusService.Turn == playerService.GetIdentity() ? "border-warning" : "")">
                                <div class="stats-row mb-3">
                                    <div class="stat">Karty: @statusService.CardsInHand.Count()</div>
                                    <div>
                                        @for (int i = 0; i < statusService.PlayerHp; i++)
                                        {
                                            <span class="hp-dot"></span>
                                        }
                                    </div>
                                    <div class="stat">Pkt: @statusService.CardsOnBoard.Sum(x => x.Owner == playerService.GetIdentity() ? x.CurrentStrength : 0)</div>
                                </div>
                                <div class="player-bottom">
                                    <div class="commander-slot" @onclick="async () => await gameService.LeaderClicked()">
                                        <img src="" alt="">
                                    </div>
                                    <div class="faction-label">@statusService.PlayerLeaderCard.Faction</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- srodek -->
                    <div class="col-12 col-md-6 col-lg-8">
                        <div class="panel-wood">

                            <!-- rowsy wroga -->
                            <div class="lane-wrapper">
                                <div class="lane-score">@statusService.CardsOnBoard.Sum(x => x.Placement == TroopPlacement.Siege && x.Owner == playerService.EnemyIdentity() ? x.CurrentStrength : 0)</div>
                                <div id="enemyHornLaneSiege" class="lane-extra-slot">
                                    @if(statusService.CardsOnBoard.Any(x=>x.Owner==playerService.EnemyIdentity() && x.Placement == TroopPlacement.Siege && x.CardId == 6))
                                    {
                                        <div class="card-slot">
                                            <div class="card">
                                                <img src="" alt="Karta wroga">
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div id="enemyLaneSiege" class="lane" @onclick="async () => await gameService.EnemyLaneClicked(TroopPlacement.Siege)">
                                    @foreach (var card in statusService.CardsOnBoard.Where(x => x.Placement == TroopPlacement.Siege && x.Owner == playerService.EnemyIdentity() && x.CardId != 6).OrderBy(x => x.Strength))
                                    {
                                        <div id="@($"card-on-board-{card.PrimaryId}")" class="card-slot">
                                            <div class="card">
                                                <img src="" alt="Karta wroga">
                                                <div class="pow">@card.CurrentStrength</div>
                                                <div class="name">@card.Name</div>
                                            </div>
                                        </div>   
                                    }
                                </div>
                            </div>

                            <div class="lane-wrapper">
                                <div class="lane-score">@statusService.CardsOnBoard.Sum(x => x.Placement == TroopPlacement.Range && x.Owner == playerService.EnemyIdentity() ? x.CurrentStrength : 0)</div>
                                <div id="enemyHornLaneRange" class="lane-extra-slot">
                                    @if (statusService.CardsOnBoard.Any(x => x.Owner == playerService.EnemyIdentity() && x.Placement == TroopPlacement.Range && x.CardId == 6))
                                    {
                                        <div class="card-slot">
                                            <div class="card">
                                                <img src="" alt="Karta wroga">
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div id="enemyLaneRange" class="lane" @onclick="async () => await gameService.EnemyLaneClicked(TroopPlacement.Range)">
                                    @foreach (var card in statusService.CardsOnBoard.Where(x => x.Placement == TroopPlacement.Range && x.Owner == playerService.EnemyIdentity() && x.CardId != 6).OrderBy(x => x.Strength))
                                    {
                                        <div id="@($"card-on-board-{card.PrimaryId}")" class="card-slot">
                                            <div class="card">
                                                <img src="" alt="Karta wroga">
                                                <div class="pow">@card.CurrentStrength</div>
                                                <div class="name">@card.Name</div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="lane-wrapper">
                                <div class="lane-score">@statusService.CardsOnBoard.Sum(x => x.Placement == TroopPlacement.Melee && x.Owner == playerService.EnemyIdentity() ? x.CurrentStrength : 0)</div>
                                <div id="enemyHornLaneMelee" class="lane-extra-slot">
                                    @if (statusService.CardsOnBoard.Any(x => x.Owner == playerService.EnemyIdentity() && x.Placement == TroopPlacement.Melee && x.CardId == 6))
                                    {
                                        <div class="card-slot">
                                            <div class="card">
                                                <img src="" alt="Karta wroga">
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div id="enemyLaneMelee" class="lane" @onclick="async () => await gameService.EnemyLaneClicked(TroopPlacement.Melee)">
                                    @foreach (var card in statusService.CardsOnBoard.Where(x => x.Placement == TroopPlacement.Melee && x.Owner == playerService.EnemyIdentity() && x.CardId != 6).OrderBy(x => x.Strength))
                                    {
                                        <div id="@($"card-on-board-{card.PrimaryId}")" class="card-slot">
                                            <div class="card">
                                                <img src="" alt="Karta wroga">
                                                <div class="pow">@card.CurrentStrength</div>
                                                <div class="name">@card.Name</div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <hr class="border-3 border-dark opacity-75 my-2">

                            <!-- rowsy gracza -->
                            <div class="lane-wrapper">
                                <div class="lane-score">@statusService.CardsOnBoard.Sum(x => x.Placement == TroopPlacement.Melee && x.Owner == playerService.GetIdentity() ? x.CurrentStrength : 0)</div>
                                <div id="playerHornLaneMelee" class="lane-extra-slot" @onclick="async () => await gameService.HornClicked(TroopPlacement.Melee)">
                                    @if (statusService.CardsOnBoard.Any(x => x.Owner == playerService.GetIdentity() && x.Placement == TroopPlacement.Melee && x.CardId == 6))
                                    {
                                        <div class="card-slot">
                                            <div class="card">
                                                <img src="" alt="Karta wroga">
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div id="playerLaneMelee" class="lane" @onclick="async () => await gameService.PlayerLaneClicked(TroopPlacement.Melee)">
                                    @foreach (var card in statusService.CardsOnBoard.Where(x => x.Placement == TroopPlacement.Melee && x.Owner == playerService.GetIdentity() && x.CardId != 6).OrderBy(x => x.Strength))
                                    {
                                        <div id="@($"card-on-board-{card.PrimaryId}")" class="card-slot">
                                            <div class="card" @onclick="async () => await gameService.CardClicked(card)">
                                                <img src="" alt="Karta">
                                                <div class="pow">@card.CurrentStrength</div>
                                                <div class="name">@card.Name</div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="lane-wrapper">
                                <div class="lane-score">@statusService.CardsOnBoard.Sum(x => x.Placement == TroopPlacement.Range && x.Owner == playerService.GetIdentity() ? x.CurrentStrength : 0)</div>
                                <div id="playerHornLaneRange" class="lane-extra-slot" @onclick="async () => await gameService.HornClicked(TroopPlacement.Range)">
                                    @if (statusService.CardsOnBoard.Any(x => x.Owner == playerService.GetIdentity() && x.Placement == TroopPlacement.Range && x.CardId == 6))
                                    {
                                        <div class="card-slot">
                                            <div class="card">
                                                <img src="" alt="Karta wroga">
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div id="playerLaneRange" class="lane" @onclick="async () => await gameService.PlayerLaneClicked(TroopPlacement.Range)">
                                    @foreach (var card in statusService.CardsOnBoard.Where(x => x.Placement == TroopPlacement.Range && x.Owner == playerService.GetIdentity() && x.CardId != 6).OrderBy(x => x.Strength))
                                    {
                                        <div id="@($"card-on-board-{card.PrimaryId}")" class="card-slot">
                                            <div class="card" @onclick="async () => await gameService.CardClicked(card)">
                                                <img src="" alt="">
                                                <div class="pow">@card.CurrentStrength</div>
                                                <div class="name">@card.Name</div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="lane-wrapper">
                                <div class="lane-score">@statusService.CardsOnBoard.Sum(x => x.Placement == TroopPlacement.Siege && x.Owner == playerService.GetIdentity() ? x.CurrentStrength : 0)</div>
                                <div id="playerHornLaneSiege" class="lane-extra-slot" @onclick="async () => await gameService.HornClicked(TroopPlacement.Siege)">
                                    @if (statusService.CardsOnBoard.Any(x => x.Owner == playerService.GetIdentity() && x.Placement == TroopPlacement.Siege && x.CardId == 6))
                                    {
                                        <div class="card-slot">
                                            <div class="card">
                                                <img src="" alt="Karta wroga">
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div id="playerLaneSiege" class="lane" @onclick="async () => await gameService.PlayerLaneClicked(TroopPlacement.Siege)">
                                    @foreach (var card in statusService.CardsOnBoard.Where(x => x.Placement == TroopPlacement.Siege && x.Owner == playerService.GetIdentity() && x.CardId != 6).OrderBy(x => x.Strength))
                                    {
                                        <div id="@($"card-on-board-{card.PrimaryId}")" class="card-slot">
                                            <div class="card" @onclick="async () => await gameService.CardClicked(card)">
                                                <img src="" alt="Karta">
                                                <div class="pow">@card.CurrentStrength</div>
                                                <div class="name">@card.Name</div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <hr class="border-3 border-dark opacity-75 my-2">

                            <!-- deck gracza -->
                            <div class="lane-wrapper">
                                <div id="player-cards-in-hand" class="lane border-warning">
                                    
                                    @foreach (var card in statusService.CardsInHand.OrderBy(x=>x.Strength))
                                    {
                                        <div id="@($"card-in-hand-{card.PrimaryId}")" class="card-slot" @onclick="()=>statusService.CardSelected(card)">
                                            <div class="card">
                                                <img src="" alt="">
                                                <div class="pow">@card.Strength</div><!-- jesli karty nie mające hp, np pogoda lub manekin to nie wyswietlac sily -->
                                                <div class="name">@card.Name</div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- lewa strona -->
                    <div class="col-1">
                        <div class="side">
                            <div class="deck-slot">
                                <div class="title">Odrzucone karty wroga</div>
                                <div class="card-holder">
                                    <img src="" alt="Odrzucone karty wroga">
                                </div>
                                <div class="count">x @statusService.EnemyUsedCardsCount</div>
                            </div>

                            <div id="enemy-deck-count" class="deck-slot">
                                <div class="title">Talia wroga</div>
                                <div class="card-holder">
                                    <img src="" alt="Taila wroga">
                                </div>
                                <div class="count">x @statusService.EnemyDeckCount</div>
                            </div>

                            <div class="deck-slot">
                                <div class="title">Twoje odrzucone karty</div>
                                <div class="card-holder">
                                    <img src="" alt="Twoje odrzucone karty">
                                </div>
                                <div class="count">x @statusService.PlayerUsedCards.Count()</div>
                            </div>

                            <div id="player-deck-count" class="deck-slot">
                                <div class="title">Twoja talia</div>
                                <div class="card-holder">
                                    <img src="" alt="Twoja talia">
                                </div>
                                <div class="count">x @statusService.PlayerDeckCount</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>



@code {
    protected override async Task OnInitializedAsync()
    {
        if (!playerService.IsDataValid())
        {
            navigationManager.NavigateTo("/");
            return;
        }

        await gameService.GetStartStatus();
        await gameService.JoinBoardAsync();

        statusService.OnStateChanged += RefreshState;

    }

    public async Task RefreshState()
    {
        StateHasChanged();
    }
}
